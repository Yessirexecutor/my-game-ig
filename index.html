<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEON HANGOUT | TRUE MULTIPLAYER</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-wrap { position: relative; width: 800px; height: 500px; border: 2px solid #222; background: #050505; }
        canvas { display: block; }
        
        #ui-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #chat-input { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 60%; background: rgba(0,0,0,0.9); border: 1px solid #0ff; color: #0ff; padding: 10px; outline: none; display: none; z-index: 50; }
        #player-list { position: absolute; top: 10px; right: 10px; text-align: right; font-size: 10px; color: #0ff; pointer-events: none; }
        
        .setup-group { margin: 15px; text-align: center; }
        input[type="text"] { background: #111; border: 1px solid #444; color: #fff; padding: 10px; text-align: center; width: 220px; }
        .hat-grid { display: flex; gap: 8px; margin-top: 10px; }
        .hat-btn { padding: 8px; border: 1px solid #444; cursor: pointer; background: #111; min-width: 50px; }
        .hat-btn.active { border-color: #0ff; background: #004444; }
        button.start { background: #0ff; border: none; padding: 12px 40px; cursor: pointer; font-weight: bold; margin-top: 20px; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="game-wrap">
    <div id="ui-overlay">
        <h1 style="color:#0ff; letter-spacing: 5px;">NEON HANGOUT</h1>
        <div class="setup-group">
            <input type="text" id="name-in" placeholder="ENTER NAME" maxlength="10">
        </div>
        <div class="setup-group">
            <label style="font-size: 10px;">THEME COLOR</label><br>
            <input type="color" id="color-in" value="#00ffff" style="width:240px; height:30px; border:none; background:none; cursor:pointer;">
        </div>
        <div class="setup-group">
            <label style="font-size: 10px;">SELECT COSMETIC</label>
            <div class="hat-grid">
                <div class="hat-btn active" onclick="setHat('none')">NONE</div>
                <div class="hat-btn" onclick="setHat('crown')">ðŸ‘‘</div>
                <div class="hat-btn" onclick="setHat('halo')">ðŸ˜‡</div>
                <div class="hat-btn" onclick="setHat('horns')">ðŸ˜ˆ</div>
            </div>
        </div>
        <button class="start" onclick="enter()">JOIN SERVER</button>
    </div>

    <div id="player-list"></div>
    <canvas id="ctx" width="800" height="500"></canvas>
    <input type="text" id="chat-input" placeholder="Press Enter to send..." maxlength="40">
</div>

<script>
/** 1. NETWORK SETUP **/
const socket = io("http://localhost:3000");

const canvas = document.getElementById('ctx');
const ctx = canvas.getContext('2d');
const chatInput = document.getElementById('chat-input');
const ui = document.getElementById('ui-overlay');
const pList = document.getElementById('player-list');

let player = { x: 400, y: 250, name: 'Guest', color: '#0ff', hat: 'none', msg: '', msgTime: 0 };
let otherPlayers = {}; 
let keys = {};

function setHat(type) {
    player.hat = type;
    document.querySelectorAll('.hat-btn').forEach(btn => {
        btn.classList.remove('active');
        if(btn.innerText.toLowerCase().includes(type) || (type === 'none' && btn.innerText === 'NONE')) btn.classList.add('active');
    });
}

function enter() {
    player.name = document.getElementById('name-in').value || 'Guest';
    player.color = document.getElementById('color-in').value;
    ui.style.display = 'none';
    socket.emit('join', { name: player.name, color: player.color, hat: player.hat });
    requestAnimationFrame(loop);
}

/** 2. CHAT & MOVEMENT SYNC **/
window.onkeydown = e => {
    if(e.code === 'Enter') {
        if(chatInput.style.display === 'block') {
            if(chatInput.value) { 
                // Set locally first for instant feedback, then emit
                player.msg = chatInput.value; 
                player.msgTime = 300;
                socket.emit('move', { x: player.x, y: player.y, msg: player.msg, msgTime: 300 }); 
            }
            chatInput.value = '';
            chatInput.style.display = 'none';
        } else {
            chatInput.style.display = 'block';
            chatInput.focus();
        }
    }
    keys[e.code] = true;
};
window.onkeyup = e => keys[e.code] = false;

/** 3. WORLD RENDERER **/
function drawCharacter(u) {
    ctx.shadowBlur = 15; ctx.shadowColor = u.color;
    ctx.fillStyle = u.color;
    ctx.fillRect(u.x, u.y, 30, 30);
    ctx.shadowBlur = 0;

    // Hat Rendering
    ctx.textAlign = 'center'; ctx.font = '20px serif';
    if(u.hat === 'crown') ctx.fillText('ðŸ‘‘', u.x + 15, u.y - 4);
    if(u.hat === 'halo') {
        ctx.strokeStyle = '#ff0'; ctx.lineWidth = 2; ctx.beginPath();
        ctx.ellipse(u.x + 15, u.y - 12, 12, 4, 0, 0, 7); ctx.stroke();
    }
    if(u.hat === 'horns') {
        ctx.fillStyle = '#f00'; ctx.beginPath();
        ctx.moveTo(u.x+5, u.y); ctx.lineTo(u.x, u.y-10); ctx.lineTo(u.x+10, u.y);
        ctx.moveTo(u.x+25, u.y); ctx.lineTo(u.x+30, u.y-10); ctx.lineTo(u.x+20, u.y); ctx.fill();
    }

    // Name & Chat Bubble
    ctx.fillStyle = '#fff'; ctx.font = '10px Courier New';
    ctx.fillText(u.name, u.x + 15, u.y + 45);

    if(u.msgTime > 0) {
        let w = ctx.measureText(u.msg).width;
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.fillRect(u.x+15-(w/2+5), u.y-55, w+10, 20);
        ctx.fillStyle = 'black';
        ctx.fillText(u.msg, u.x+15, u.y-41);
        // Note: msgTime is decremented on the server or synced via the updatePositions
    }
}

function loop() {
    ctx.fillStyle = '#050505';
    ctx.fillRect(0, 0, 800, 500);

    // Grid Floor
    ctx.strokeStyle = '#111';
    for(let i=0; i<800; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,500); ctx.stroke(); }
    for(let i=0; i<500; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(800,i); ctx.stroke(); }

    // Client-side prediction movement
    let moved = false;
    if(ui.style.display !== 'flex' && chatInput.style.display !== 'block') {
        if(keys.KeyW) { player.y -= 4; moved = true; }
        if(keys.KeyS) { player.y += 4; moved = true; }
        if(keys.KeyA) { player.x -= 4; moved = true; }
        if(keys.KeyD) { player.x += 4; moved = true; }
    }

    // Send position AND chat state to server
    if(moved) {
        socket.emit('move', { x: player.x, y: player.y, msg: player.msg, msgTime: player.msgTime });
    }

    // Draw everyone based on SERVER data
    for(let id in otherPlayers) {
        drawCharacter(otherPlayers[id]);
        
        // If this is US, update our local msgTime so it fades out
        if(id === socket.id && otherPlayers[id].msgTime > 0) {
            player.msgTime = otherPlayers[id].msgTime;
        }
    }

    requestAnimationFrame(loop);
}

/** 4. SYNC LISTENER **/
socket.on('updatePositions', (data) => {
    otherPlayers = data;
    
    let names = "ONLINE:<br>";
    for(let id in data) { names += data[id].name + "<br>"; }
    pList.innerHTML = names;
});
</script>
</body>
</html>