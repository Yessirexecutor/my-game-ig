<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEON WORLD | CLEAR VIEW UPDATE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-wrap { position: relative; width: 800px; height: 500px; border: 2px solid #0ff; background: #000; overflow: hidden; box-shadow: 0 0 20px #0ff; border-radius: 10px; }
        canvas { display: block; }
        #ui-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #chat-input { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 50%; background: rgba(0,0,0,0.8); border: 1px solid #0ff; color: #0ff; padding: 12px; outline: none; display: none; z-index: 50; border-radius: 20px; text-align: center; }
        #leave-btn { position: absolute; top: 15px; left: 15px; background: rgba(255,0,0,0.2); border: 1px solid #f00; color: #f00; padding: 5px 12px; cursor: pointer; font-size: 10px; display: none; z-index: 60; border-radius: 3px; }
        
        .emoji-panel { width: 350px; height: 180px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; margin: 10px 0; display: flex; flex-direction: column; }
        .emoji-grid { flex: 1; overflow-y: scroll; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; padding: 10px; }
        .emoji-btn { background: #222; border: 1px solid #444; color: #fff; padding: 5px; cursor: pointer; border-radius: 5px; font-size: 22px; transition: 0.2s; }
        .emoji-btn:hover { border-color: #0ff; }
        .emoji-btn.active { border-color: #0ff; background: #004444; }
        #emoji-search { background: #111; border: none; border-bottom: 1px solid #444; color: #0ff; padding: 8px; width: 100%; outline: none; font-size: 12px; box-sizing: border-box; }

        input { background: #111; border: 1px solid #444; color: #fff; padding: 10px; text-align: center; border-radius: 5px; margin: 5px; outline: none; }
        button#join-btn { background: #0ff; border: none; padding: 12px 40px; cursor: pointer; font-weight: bold; margin-top: 10px; border-radius: 5px; color: #000; text-transform: uppercase; }
        .secret-box { width: 120px; font-size: 9px; opacity: 0.3; margin-top: 15px; }
    </style>
</head>
<body>

<div id="game-wrap">
    <div id="ui-overlay">
        <h1 style="color:#0ff; letter-spacing: 5px;">NEON WORLD</h1>
        <input type="text" id="name-in" placeholder="NICKNAME" maxlength="10">
        <div class="emoji-panel">
            <input type="text" id="emoji-search" placeholder="Search Hats..." oninput="filterEmojis(this.value)">
            <div class="emoji-grid" id="emoji-container"></div>
        </div>
        <button id="join-btn" onclick="initP2P()">ENTER WORLD</button>
        <input type="password" class="secret-box" placeholder="ACCESS CODE" oninput="checkKey(this.value)">
    </div>
    <button id="leave-btn" onclick="location.reload()">LEAVE</button>
    <canvas id="ctx" width="800" height="500"></canvas>
    <input type="text" id="chat-input" placeholder="Type message..." maxlength="60">
</div>

<script>
const canvas = document.getElementById('ctx');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui-overlay');
let peer, conn, connections = [];
let player = { x: 385, y: 235, name: 'Guest', color: '#0ff', hat: 'ğŸ‘‘', isAdmin: false, isGhost: false, msg: '', msgTime: 0, lastSeen: Date.now(), burn: 0 };
let otherPlayers = {};
let keys = {};
let broadcast = { text: '', x: 800, active: false };

let eventTimers = { rain: 0, disco: 0, glitch: 0, earthquake: 0, meteor: 0, invert: 0, lava: 0 };
let rainParts = [], meteors = [];
let showHelp = 0, shakeX = 0, shakeY = 0;

const emojiList = ["ğŸ‘‘","ğŸ©","ğŸ“","â›‘ï¸","ğŸ","ğŸ”","ğŸ•","ğŸ¦","âš½","ğŸ®","ğŸ¸","ğŸ’","ğŸ”¥","â­","âš¡","ğŸŒˆ","ğŸ±","ğŸ¶","ğŸ¦Š","ğŸ¦","ğŸ¯","ğŸ®","ğŸ·","ğŸ¸","ğŸ™","ğŸ‘½","ğŸ‘»","ğŸ’€","ğŸ„","ğŸš€","ğŸ›¸"];

function loadEmojis() {
    const container = document.getElementById('emoji-container');
    container.innerHTML = `<button class="emoji-btn" onclick="setHat('', this)">âŒ</button>`;
    emojiList.forEach(e => {
        container.innerHTML += `<button class="emoji-btn" onclick="setHat('${e}', this)">${e}</button>`;
    });
}
loadEmojis();

function setHat(emoji, btn) {
    player.hat = emoji;
    document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
}

function checkKey(val) {
    player.isAdmin = player.isGhost = false; player.color = "#0ff";
    if (val === 'brax-admin-99') { player.isAdmin = true; player.color = "#fff"; }
}

function initP2P() {
    player.name = document.getElementById('name-in').value || 'Guest';
    peer = new Peer('NEON_FINAL_EMOJI_V1');
    peer.on('open', () => { 
        peer.on('connection', c => {
            connections.push(c);
            c.on('data', data => { 
                if(data.type === 'bc') { broadcast.text = data.text; broadcast.x = 800; broadcast.active = true; }
                if(data.type === 'ev') { eventTimers[data.mode] = 600; }
                if(data.id) { data.lastSeen = Date.now(); otherPlayers[data.id] = data; } 
            });
        });
        start(); 
    });
    peer.on('error', () => {
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('NEON_FINAL_EMOJI_V1');
            conn.on('data', data => { 
                if(data.type === 'bc') { broadcast.text = data.text; broadcast.x = 800; broadcast.active = true; }
                if(data.type === 'ev') { eventTimers[data.mode] = 600; }
                if(data.type==='sync') { for(let id in data.players) data.players[id].lastSeen = Date.now(); otherPlayers = data.players; } 
            });
            start();
        });
    });
}

function start() { ui.style.display = 'none'; document.getElementById('leave-btn').style.display = 'block'; requestAnimationFrame(loop); }

function drawPlayer(u) {
    let now = Date.now();
    ctx.save();
    if (eventTimers.invert > 0) ctx.filter = 'invert(1)';
    
    // Character
    ctx.fillStyle = u.burn > 50 ? "#f50" : u.color;
    ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
    let s = (eventTimers.disco > 0) ? 30 + Math.sin(now/100)*5 : 30;
    ctx.fillRect(u.x, u.y, s, s);
    ctx.shadowBlur = 0;

    let bob = Math.sin(now / 200) * 5;
    
    // 1. HAT (Closest to head)
    if(u.hat) {
        ctx.font = '22px serif'; ctx.textAlign = 'center';
        ctx.fillText(u.hat, u.x + 15, u.y - 10 + bob);
    }

    // 2. CHAT MESSAGE (Above the hat)
    if(u.msgTime > 0) {
        ctx.font = 'bold 12px Courier'; ctx.fillStyle = "#fff";
        ctx.fillText(u.msg, u.x + 15, u.y - 40 + bob);
        u.msgTime--;
    }

    // 3. OWNER TAG (Highest)
    if(u.isAdmin) {
        ctx.font = 'bold 10px Courier';
        ctx.fillStyle = `hsl(${(now/10)%360}, 100%, 70%)`;
        ctx.fillText('OWNER', u.x+15, u.y - 55 + bob);
    }

    // Name Tag (Below)
    ctx.fillStyle = "#fff"; ctx.font = '10px Courier';
    ctx.fillText(u.name, u.x+15, u.y+45);
    ctx.restore();
}

function loop() {
    shakeX = (eventTimers.earthquake > 0) ? (Math.random()-0.5)*12 : 0;
    shakeY = (eventTimers.earthquake > 0) ? (Math.random()-0.5)*12 : 0;
    if(eventTimers.earthquake > 0) eventTimers.earthquake--;

    ctx.save(); ctx.translate(shakeX, shakeY);
    
    let bg = "#000";
    if(eventTimers.rain > 0) bg = "#001";
    if(eventTimers.lava > 0) bg = "#210";
    ctx.fillStyle = bg; ctx.fillRect(0,0,800,500);

    if(document.getElementById('chat-input').style.display !== 'block') {
        let s = 4;
        let up="KeyW", down="KeyS", left="KeyA", right="KeyD";
        if(eventTimers.invert > 0) { up="KeyS"; down="KeyW"; left="KeyD"; right="KeyA"; }
        let moved = false;
        if(keys[up] && player.y > 0) { player.y -= s; moved = true; }
        if(keys[down] && player.y < 470) { player.y += s; moved = true; }
        if(keys[left] && player.x > 0) { player.x -= s; moved = true; }
        if(keys[right] && player.x < 770) { player.x += s; moved = true; }
        if(eventTimers.lava > 0 && !moved) player.burn++; else player.burn = Math.max(0, player.burn-1);
    }

    if(conn && conn.open) conn.send({ id: peer.id, ...player });
    else connections.forEach(c => c.open && c.send({ type:'sync', players: { [peer.id]: player, ...otherPlayers } }));

    // Weather Effects
    if(eventTimers.rain > 0) {
        if(Math.random() > 0.5) rainParts.push({x: Math.random()*800, y: -10, s: Math.random()*10});
    }
    rainParts.forEach((p, i) => {
        ctx.fillStyle = "#0ff"; ctx.fillRect(p.x, p.y, 1, p.s);
        p.y += 12; if(p.y > 500) rainParts.splice(i, 1);
    });

    for(let id in otherPlayers) drawPlayer(otherPlayers[id]);
    drawPlayer(player);

    if(broadcast.active) {
        ctx.font = "bold 40px Courier"; ctx.fillStyle = `hsl(${(Date.now()/5)%360}, 100%, 70%)`;
        ctx.fillText(broadcast.text.toUpperCase(), broadcast.x, 250);
        broadcast.x -= 7; if(broadcast.x < -1000) broadcast.active = false;
    }

    if(showHelp > 0) {
        showHelp--;
        ctx.fillStyle = "rgba(0,0,0,0.85)"; ctx.fillRect(150, 80, 500, 340);
        ctx.fillStyle = "#0ff"; ctx.textAlign = "center";
        ctx.fillText("--- OWNER COMMANDS ---", 400, 120);
        let list = ["/all [msg]", "/event rain", "/event disco", "/event glitch", "/event earthquake", "/event meteor", "/event lava", "/event invert"];
        list.forEach((t, i) => ctx.fillText(t, 400, 160 + (i*25)));
    }

    ctx.restore();
    if(eventTimers.glitch > 0) { eventTimers.glitch--; if(Math.random()>0.9) ctx.clearRect(Math.random()*800, 0, 30, 500); }
    if(eventTimers.invert > 0) eventTimers.invert--;
    requestAnimationFrame(loop);
}

window.onkeydown = e => {
    keys[e.code] = true;
    if(e.code === 'Enter') {
        const ci = document.getElementById('chat-input');
        if(ci.style.display === 'block') {
            let val = ci.value.trim();
            if(val) {
                if(player.isAdmin && val === '/event help') showHelp = 300;
                else if(player.isAdmin && val.startsWith('/all ')) {
                    let msg = val.substring(5);
                    broadcast.text = msg; broadcast.x = 800; broadcast.active = true;
                    let d = { type: 'bc', text: msg };
                    if(conn) conn.send(d); else connections.forEach(c => c.send(d));
                } else if (player.isAdmin && val.startsWith('/event ')) {
                    let mode = val.substring(7);
                    if(eventTimers.hasOwnProperty(mode)) {
                        eventTimers[mode] = 600;
                        let d = { type: 'ev', mode: mode };
                        if(conn) conn.send(d); else connections.forEach(c => c.send(d));
                    }
                } else { player.msg = val; player.msgTime = 150; }
            }
            ci.style.display = 'none'; ci.value = '';
        } else if(ui.style.display === 'none') { ci.style.display = 'block'; ci.focus(); }
    }
};
window.onkeyup = e => keys[e.code] = false;
</script>
</body>
</html>