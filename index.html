<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEON HANGOUT | ROLES UPDATE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-wrap { position: relative; width: 800px; height: 500px; border: 2px solid #0ff; background: #000; overflow: hidden; box-shadow: 0 0 20px #0ff; }
        canvas { display: block; position: relative; z-index: 10; }
        
        #ui-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #chat-input { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 50%; background: rgba(0,0,0,0.8); border: 1px solid #0ff; color: #0ff; padding: 12px; outline: none; display: none; z-index: 50; border-radius: 20px; text-align: center; }
        
        .hat-list-container { width: 340px; height: 160px; overflow-y: auto; background: rgba(255, 255, 255, 0.05); border: 1px solid #444; border-radius: 8px; padding: 10px; margin: 10px 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .hat-btn { background: #222; border: 1px solid #444; color: #fff; padding: 10px; cursor: pointer; border-radius: 5px; font-size: 20px; }
        .hat-btn.active { border-color: #0ff; background: #004444; }
        
        #admin-hat-btn { display: none; border: 2px solid #f0f; background: #202; box-shadow: 0 0 10px #f0f; }

        input[type="text"], input[type="password"] { background: #111; border: 1px solid #444; color: #fff; padding: 10px; text-align: center; border-radius: 5px; margin: 5px; outline: none; }
        button#join-btn { background: #0ff; border: none; padding: 15px 50px; cursor: pointer; font-weight: bold; margin-top: 15px; border-radius: 5px; }
        #secret-wrap { border-top: 1px solid #222; margin-top: 15px; padding-top: 10px; display: flex; flex-direction: column; align-items: center; }
        .secret-label { font-size: 9px; color: #555; margin-bottom: 2px; }
    </style>
</head>
<body>

<div id="game-wrap">
    <div id="ui-overlay">
        <h1 style="color:#0ff; letter-spacing: 5px; text-shadow: 0 0 10px #0ff;">NEON HANGOUT</h1>
        <input type="text" id="name-in" placeholder="NICKNAME" maxlength="10">
        
        <div class="hat-list-container">
            <button id="admin-hat-btn" class="hat-btn" onclick="setHat('admin', this)">üõ°Ô∏è</button>
            <button class="hat-btn active" onclick="setHat('none', this)">‚ùå</button>
            <button class="hat-btn" onclick="setHat('snow', this)">‚ùÑÔ∏è</button>
            <button class="hat-btn" onclick="setHat('cloud', this)">‚òÅÔ∏è</button>
            <button class="hat-btn" onclick="setHat('water', this)">üíß</button>
            <button class="hat-btn" onclick="setHat('fire', this)">üî•</button>
            <button class="hat-btn" onclick="setHat('pizza', this)">üçï</button>
            <button class="hat-btn" onclick="setHat('alien', this)">üëΩ</button>
        </div>

        <button id="join-btn" onclick="initP2P()">ENTER WORLD</button>

        <div id="secret-wrap">
            <span class="secret-label">ROLE CODES</span>
            <input type="password" id="role-key" placeholder="ENTER CODE" oninput="checkKey(this.value)" style="width:120px; font-size:9px;">
        </div>
    </div>

    <canvas id="ctx" width="800" height="500"></canvas>
    <input type="text" id="chat-input" placeholder="Press Enter to Chat..." maxlength="40">
</div>

<script>
const canvas = document.getElementById('ctx');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui-overlay');
let peer, conn, connections = [];
let player = { x: 385, y: 235, name: 'Guest', color: '#0ff', hat: 'none', isAdmin: false, isTrusted: false };
let otherPlayers = {};
let keys = {};
let fxParticles = [];

const hatMap = { 'admin':'üõ°Ô∏è', 'snow':'‚ùÑÔ∏è', 'cloud':'‚òÅÔ∏è', 'water':'üíß', 'fire':'üî•', 'pizza':'üçï', 'alien':'üëΩ' };

function checkKey(val) {
    // RESET ROLES
    player.isAdmin = false;
    player.isTrusted = false;
    document.getElementById('admin-hat-btn').style.display = 'none';
    player.color = "#0ff";

    if (val === 'brax-admin-99') {
        player.isAdmin = true;
        player.color = "#ffffff";
        document.getElementById('admin-hat-btn').style.display = 'block';
    } else if (val === 'friend-access-11') {
        player.isTrusted = true;
        player.color = "#00ffff";
    }
}

function createHatFX(u) {
    if (u.hat === 'fire') fxParticles.push({ x: u.x+15, y: u.y+15, vx: Math.random()-0.5, vy: -1.5, life: 40, color: '#ff4400', s: 4 });
    if (u.hat === 'snow') fxParticles.push({ x: u.x+Math.random()*30, y: u.y, vx: (Math.random()-0.5), vy: 1, life: 70, color: '#fff', s: 2.5 });
    if (u.hat === 'water') fxParticles.push({ x: u.x+15+(Math.random()-0.5)*30, y: u.y+10, vx: Math.sin(Date.now()/500)*0.5, vy: -1, life: 50, color: '#0af', s: 3 });
    
    if (u.hat === 'admin') {
        const chars = ["0", "1", "<", ">"];
        if (Math.random() > 0.4) {
            fxParticles.push({ 
                x: u.x + 15 + Math.cos(Date.now()/150)*25, 
                y: u.y + 15 + Math.sin(Date.now()/150)*25, 
                vx: 0, vy: -0.8, life: 40, color: '#0f0', s: 10, 
                type: 'code', txt: chars[Math.floor(Math.random()*chars.length)] 
            });
        }
    }
}

function updateFX() {
    for (let i = fxParticles.length - 1; i >= 0; i--) {
        let p = fxParticles[i];
        p.x += p.vx; p.y += p.vy; p.life--;
        ctx.globalAlpha = p.life / 60;
        if(p.type === 'code') {
            ctx.fillStyle = '#0f0'; ctx.font = '8px monospace';
            ctx.fillText(p.txt, p.x, p.y);
        } else {
            ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.s, p.s);
        }
        if (p.life <= 0) fxParticles.splice(i, 1);
    }
    ctx.globalAlpha = 1;
}

function setHat(type, btn) {
    player.hat = type;
    document.querySelectorAll('.hat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function initP2P() {
    player.name = document.getElementById('name-in').value || 'Guest';
    peer = new Peer('NEON_BRAX_ROLE_V1');
    peer.on('open', () => { setupHost(); start(); });
    peer.on('error', () => {
        peer = new Peer();
        peer.on('open', () => { connectToHost('NEON_BRAX_ROLE_V1'); start(); });
    });
}

function setupHost() {
    peer.on('connection', (c) => {
        connections.push(c);
        c.on('data', (data) => { if(data.id) { otherPlayers[data.id] = data; broadcast(); } });
    });
}

function connectToHost(id) {
    conn = peer.connect(id);
    conn.on('data', (data) => { if (data.type === 'sync') otherPlayers = data.players; });
}

function broadcast() {
    connections.forEach(c => { if(c.open) c.send({ type: 'sync', players: { [peer.id]: player, ...otherPlayers } }); });
}

function start() { ui.style.display = 'none'; requestAnimationFrame(loop); }

function drawCharacter(u) {
    createHatFX(u);
    ctx.fillStyle = u.color; 
    ctx.shadowBlur = 15; ctx.shadowColor = u.color;
    ctx.fillRect(u.x, u.y, 30, 30);
    ctx.shadowBlur = 0;

    // ROLE TITLES
    let titleBob = Math.sin(Date.now() / 250) * 5;
    if(u.isAdmin) {
        let hue = (Date.now() / 10) % 360;
        ctx.fillStyle = `hsl(${hue}, 100%, 70%)`;
        ctx.font = 'bold 12px "Courier New"';
        ctx.textAlign = 'center';
        ctx.fillText('OWNER', u.x + 15, u.y - 35 + titleBob);
        
        if(u.hat === 'admin') {
            ctx.fillStyle = "#fff"; ctx.fillRect(u.x + 8, u.y + 10, 14, 10);
            ctx.fillStyle = "#0f0"; ctx.font = "bold 6px monospace"; ctx.fillText("ADM", u.x + 15, u.y + 17);
        }
    } else if (u.isTrusted) {
        // Cyan/Blue shifting gradient
        let shift = Math.sin(Date.now() / 500) * 30;
        ctx.fillStyle = `hsl(${180 + shift}, 100%, 60%)`;
        ctx.font = 'bold 11px "Courier New"';
        ctx.textAlign = 'center';
        ctx.fillText('TRUSTED', u.x + 15, u.y - 35 + titleBob);
    }

    let bob = Math.sin(Date.now() / 200) * 3;
    if(u.hat !== 'none' && u.hat !== 'admin') {
        ctx.font = '22px serif'; ctx.textAlign = 'center';
        ctx.fillText(hatMap[u.hat], u.x+15, u.y-6+bob);
    }
    
    ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Courier New'; ctx.textAlign = 'center';
    ctx.fillText(u.name, u.x + 15, u.y + 45);
}

function loop() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,800,500);
    updateFX();
    if(document.getElementById('chat-input').style.display !== 'block') {
        if(keys.KeyW && player.y > 0) player.y -= 4;
        if(keys.KeyS && player.y < 470) player.y += 4;
        if(keys.KeyA && player.x > 0) player.x -= 4;
        if(keys.KeyD && player.x < 770) player.x += 4;
    }
    if (conn && conn.open) conn.send({ id: peer.id, ...player });
    else broadcast();
    for(let id in otherPlayers) drawCharacter(otherPlayers[id]);
    drawCharacter(player);
    requestAnimationFrame(loop);
}

window.onkeydown = e => {
    if(e.code === 'Enter' && ui.style.display === 'none') {
        const ci = document.getElementById('chat-input');
        if(ci.style.display === 'block') {
            if(ci.value.trim()){ player.msg = ci.value; player.msgTime = 250; }
            ci.value = ''; ci.style.display = 'none';
        } else { ci.style.display = 'block'; ci.focus(); }
    }
    keys[e.code] = true;
};
window.onkeyup = e => keys[e.code] = false;
</script>
</body>
</html>