<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEON HANGOUT | FINAL ROLES</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-wrap { position: relative; width: 800px; height: 500px; border: 2px solid #0ff; background: #000; overflow: hidden; box-shadow: 0 0 20px #0ff; border-radius: 10px; }
        canvas { display: block; }
        
        #ui-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #chat-input { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 50%; background: rgba(0,0,0,0.8); border: 1px solid #0ff; color: #0ff; padding: 12px; outline: none; display: none; z-index: 50; border-radius: 20px; text-align: center; }
        
        #leave-btn { position: absolute; top: 15px; left: 15px; background: rgba(255,0,0,0.2); border: 1px solid #f00; color: #f00; padding: 5px 12px; cursor: pointer; font-size: 10px; display: none; z-index: 60; border-radius: 3px; }
        #music-btn { position: absolute; bottom: 15px; right: 15px; background: rgba(0,255,255,0.1); border: 1px solid #0ff; color: #0ff; padding: 5px 12px; cursor: pointer; font-size: 10px; display: none; z-index: 60; border-radius: 3px; }

        .hat-grid { width: 340px; height: 160px; overflow-y: auto; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 8px; padding: 10px; margin: 10px 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .hat-btn { background: #222; border: 1px solid #444; color: #fff; padding: 10px; cursor: pointer; border-radius: 5px; font-size: 20px; }
        .hat-btn.active { border-color: #0ff; background: #004444; }
        #admin-hat-btn, #vip-hat-btn { display: none; }
        #admin-hat-btn { border: 2px solid #0f0; }
        #vip-hat-btn { border: 2px solid #f0f; }

        input { background: #111; border: 1px solid #444; color: #fff; padding: 10px; text-align: center; border-radius: 5px; margin: 5px; outline: none; }
        button#join-btn { background: #0ff; border: none; padding: 15px 50px; cursor: pointer; font-weight: bold; margin-top: 15px; border-radius: 5px; color: #000; }
        .secret-box { width: 120px; font-size: 9px; opacity: 0.4; }
    </style>
</head>
<body>

<div id="game-wrap">
    <div id="ui-overlay">
        <h1 style="color:#0ff; letter-spacing: 5px;">NEON WORLD</h1>
        <input type="text" id="name-in" placeholder="NICKNAME" maxlength="10">
        
        <div class="hat-grid">
            <button id="admin-hat-btn" class="hat-btn" onclick="setHat('admin', this)">üõ°Ô∏è</button>
            <button id="vip-hat-btn" class="hat-btn" onclick="setHat('diamond', this)">üíé</button>
            <button class="hat-btn active" onclick="setHat('none', this)">‚ùå</button>
            <button class="hat-btn" onclick="setHat('snow', this)">‚ùÑÔ∏è</button>
            <button class="hat-btn" onclick="setHat('cloud', this)">‚òÅÔ∏è</button>
            <button class="hat-btn" onclick="setHat('water', this)">üíß</button>
            <button class="hat-btn" onclick="setHat('fire', this)">üî•</button>
            <button class="hat-btn" onclick="setHat('pizza', this)">üçï</button>
            <button class="hat-btn" onclick="setHat('alien', this)">üëΩ</button>
        </div>

        <button id="join-btn" onclick="initP2P()">ENTER WORLD</button>
        <input type="password" class="secret-box" placeholder="ACCESS CODE" oninput="checkKey(this.value)">
    </div>

    <button id="leave-btn" onclick="location.reload()">LEAVE</button>
    <button id="music-btn" onclick="toggleMusic()">üéµ MUSIC</button>
    <div id="yt-wrap"></div>

    <canvas id="ctx" width="800" height="500"></canvas>
    <input type="text" id="chat-input" placeholder="Enter message..." maxlength="40">
</div>

<script>
const canvas = document.getElementById('ctx');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui-overlay');
let peer, conn, connections = [];
let player = { x: 385, y: 235, name: 'Guest', color: '#0ff', hat: 'none', isAdmin: false, isTrusted: false, isVIP: false, msg: '', msgTime: 0 };
let otherPlayers = {};
let keys = {};
let fx = [];
let musicPlaying = false;

const hatMap = { 'admin':'üõ°Ô∏è', 'diamond':'üíé', 'snow':'‚ùÑÔ∏è', 'cloud':'‚òÅÔ∏è', 'water':'üíß', 'fire':'üî•', 'pizza':'üçï', 'alien':'üëΩ' };

function checkKey(val) {
    player.isAdmin = false; player.isTrusted = false; player.isVIP = false;
    document.getElementById('admin-hat-btn').style.display = 'none';
    document.getElementById('vip-hat-btn').style.display = 'none';
    player.color = "#0ff";

    if (val === 'brax-admin-99') {
        player.isAdmin = true; player.color = "#fff";
        document.getElementById('admin-hat-btn').style.display = 'block';
    } else if (val === 'friend-access-11') {
        player.isTrusted = true; player.color = "#0ff";
    } else if (val === 'vip-neon-77') {
        player.isVIP = true; player.color = "#f0f";
        document.getElementById('vip-hat-btn').style.display = 'block';
    }
}

function toggleMusic() {
    const wrap = document.getElementById('yt-wrap');
    if(!musicPlaying) {
        wrap.innerHTML = `<iframe width="1" height="1" src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1" frameborder="0" style="position:absolute;top:-1000px"></iframe>`;
        musicPlaying = true;
    } else { wrap.innerHTML = ''; musicPlaying = false; }
}

function spawnFX(u) {
    if (u.hat === 'fire') fx.push({ x: u.x+15, y: u.y+15, vx: Math.random()-0.5, vy: -1.5, life: 40, c: '#f40', s: 4 });
    if (u.hat === 'diamond') fx.push({ x: u.x+15, y: u.y+10, vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2, life: 30, c: '#f0f', s: 2, t:'sparkle' });
    if (u.hat === 'admin' && Math.random() > 0.5) {
        fx.push({ x: u.x+15+Math.cos(Date.now()/150)*25, y: u.y+15+Math.sin(Date.now()/150)*25, vx: 0, vy: -0.5, life: 30, c: '#0f0', s: 10, t:'code', txt: Math.random()>0.5?'1':'0' });
    }
}

function updateFX() {
    fx.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        ctx.globalAlpha = p.life / 60;
        ctx.fillStyle = p.c;
        if(p.t === 'code') { ctx.font='8px monospace'; ctx.fillText(p.txt, p.x, p.y); }
        else ctx.fillRect(p.x, p.y, p.s, p.s);
        if(p.life <= 0) fx.splice(i, 1);
    });
    ctx.globalAlpha = 1;
}

function setHat(t, btn) {
    player.hat = t;
    document.querySelectorAll('.hat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

function initP2P() {
    player.name = document.getElementById('name-in').value || 'Guest';
    peer = new Peer('BRAX_MEGA_LOBBY');
    peer.on('open', () => { 
        peer.on('connection', c => {
            connections.push(c);
            c.on('data', data => { if(data.id) otherPlayers[data.id] = data; });
        });
        start(); 
    });
    peer.on('error', () => {
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect('BRAX_MEGA_LOBBY');
            conn.on('data', data => { if(data.type==='sync') otherPlayers = data.players; });
            start();
        });
    });
}

function start() { 
    ui.style.display = 'none'; 
    document.getElementById('leave-btn').style.display = 'block';
    document.getElementById('music-btn').style.display = 'block';
    requestAnimationFrame(loop); 
}

function drawPlayer(u) {
    spawnFX(u);
    ctx.fillStyle = u.color;
    ctx.shadowBlur = 15; ctx.shadowColor = u.color;
    ctx.fillRect(u.x, u.y, 30, 30);
    ctx.shadowBlur = 0;

    let titleBob = Math.sin(Date.now() / 250) * 5;
    ctx.font = 'bold 11px Courier'; ctx.textAlign = 'center';

    if(u.isAdmin) {
        ctx.fillStyle = `hsl(${(Date.now()/10)%360}, 100%, 70%)`;
        ctx.fillText('OWNER', u.x+15, u.y-35+titleBob);
        if(u.hat==='admin') { ctx.fillStyle="#fff"; ctx.fillRect(u.x+8,u.y+10,14,10); }
    } else if(u.isTrusted) {
        ctx.fillStyle = "#0ff";
        ctx.fillText('TRUSTED', u.x+15, u.y-35+titleBob);
    } else if(u.isVIP) {
        let p = 60 + Math.sin(Date.now()/200)*20;
        ctx.fillStyle = `hsl(300, 100%, ${p}%)`;
        ctx.fillText('VIP', u.x+15, u.y-35+titleBob);
    }

    if(u.msgTime > 0) {
        ctx.fillStyle = "#fff"; ctx.fillText(u.msg, u.x+15, u.y-15);
        u.msgTime--;
    }
    
    let hBob = Math.sin(Date.now()/200)*3;
    if(u.hat !== 'none' && u.hat !== 'admin') {
        ctx.font = '20px serif'; ctx.fillText(hatMap[u.hat], u.x+15, u.y-5+hBob);
    }

    ctx.fillStyle = "#fff"; ctx.font = "10px Courier"; ctx.fillText(u.name, u.x+15, u.y+45);
}

function loop() {
    ctx.fillStyle = "#000"; ctx.fillRect(0,0,800,500);
    updateFX();
    if(document.getElementById('chat-input').style.display !== 'block') {
        if(keys.KeyW && player.y > 0) player.y -= 4;
        if(keys.KeyS && player.y < 470) player.y += 4;
        if(keys.KeyA && player.x > 0) player.x -= 4;
        if(keys.KeyD && player.x < 770) player.x += 4;
    }
    if(conn && conn.open) conn.send({ id: peer.id, ...player });
    else connections.forEach(c => c.open && c.send({ type:'sync', players: { [peer.id]: player, ...otherPlayers } }));
    
    for(let id in otherPlayers) drawPlayer(otherPlayers[id]);
    drawPlayer(player);
    requestAnimationFrame(loop);
}

window.onkeydown = e => {
    if(e.code === 'Enter') {
        const ci = document.getElementById('chat-input');
        if(ci.style.display === 'block') {
            if(ci.value.trim()) { player.msg = ci.value; player.msgTime = 150; }
            ci.style.display = 'none'; ci.value = '';
        } else if(ui.style.display === 'none') { ci.style.display = 'block'; ci.focus(); }
    }
    keys[e.code] = true;
};
window.onkeyup = e => keys[e.code] = false;
</script>
</body>
</html>